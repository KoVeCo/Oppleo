{% extends "template.html" %}
{% block title %}Instellingen{% endblock %}
{% block jquery %} 
  {% include 'includes/include.jquery-3.3.1.html' %}
{% endblock %} 
{% block head %}
  {{ super() }}
  
  <!-- Socket IO -->
  <script src="{{ url_for('static', filename='plugins/socket.io/2.3.0/socket.io.js') }}"></script>

  <!-- Bootstrap switch button -->
  <link rel="stylesheet" href="{{ url_for('static', filename='plugins/bootstrap4-toggle/3.6.1/bootstrap4-toggle.min.css') }}">
  <script src="{{ url_for('static', filename='plugins/bootstrap4-toggle/3.6.1/bootstrap4-toggle.min.js') }}"></script>


  <!-- Datepicker -->
  <link rel="stylesheet" href="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css') }}">  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/bootstrap-datepicker/datepicker-nl.js') }}"></script>

  
  <style>
    .paginate_button {
        padding: 0px !important;
    }
    .XXtbody td {
      padding: 2px 2px !important;
      text-align: center;
      background-color: #36404a;
    }
    td.diag_pre {
      box-sizing: inherit;
      overflow-x: hidden !important;
    }
    td.diag_name {
      text-align: right;
      vertical-align: top;
      padding: 10px;
      width: 60px;
    }
    td.diag_value {
      color: #3bafda;
      text-align: left;
      margin-left: 10px;
    }
    td.diag_value ul li {
      list-style-type: none;
    }
    td.diag_value ul li span:nth-of-type(1) {
      display: inline-block;
      width: 50px;
    }
    td.diag_value ul li span:nth-of-type(2) {
      display: inline-block;
      width: 100px;
      text-align: right;
    }
    .set_title {
      padding-left: 100px;
      padding-bottom: 20px;
    }
    .set_name {
      text-align: left;
      padding-left: 110px;
      /* background-color: red; */
      text-decoration: underline;
    }
    .set_val {
      text-align: left;
      padding-left: 140px;
      display: flex;
    }
    .set_val_last {
      padding-bottom: 20px;
    }
    .set_val_name {
      width: 120px;
/*      background-color: royalblue; */
      text-align: right;
      padding-right: 20px;
    }
    .set_val_val {
      text-align: left;
      width: 200px;
/*      background-color: sandybrown; */
      padding-left: 20px;
    }
    .set_val_val_right {
      text-align: right;
      width: 100px;
/*      background-color: sandybrown; */
      padding-left: 20px;
    }



    div.hours-of-day {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      width: 100%;
      height: .5em;
      margin-top: 0;
      /* background-color: red;*/
    }

    td[id^="offPeak"] {
      padding: 0px;
      padding-top: 5px;
      margin: 0px;
    }
    td[id^="offPeak"] > div:nth-child(1) {
      background-color: #ef5350;
      margin-bottom: 2px;
    }
    td[id^="offPeak"] > div:nth-child(2) {
      margin-bottom: 2px;
    }

    div.hours-of-day span {
      width: 4.166%;
      /*background-color: #00b19d; */
      border-right: 1px solid #868e96; 
      border-top: 1px solid #868e96; 
      font-size: 10px; 
      color: #868e96; /* green: #00b19d orange #ffaa00 */
    }
    div.hours-of-day span:nth-child(1) {
      border-left: 1px solid #868e96; 
    }

    .form-control {
      color: #ffffff !important;
      background-color: #434f5c;/* #576676; */
    }
    .form-control:disabled, .form-control[readonly] {
      color: #3bafda !important;
      background-color: rgba(0,0,0,.05);/* #576676; */
    }

  </style>

  <script>
    function timestamp() {
      d = new Date();
      return (d.getFullYear() + "-" + 
             (d.getMonth()<10?'0':'') + (d.getMonth()+1) + "-" + 
             (d.getDate()<10?'0':'') + d.getDate() + '.' + 
             (d.getHours()<10?'0':'') + d.getHours() + ":" + 
             (d.getMinutes()<10?'0':'') + d.getMinutes() + "." + 
             (d.getSeconds()<10?'0':'') + d.getSeconds() + '.' + 
             (d.getMilliseconds()<100?'0':'') + (d.getMilliseconds()<10?'0':'') + d.getMilliseconds()
      )
    }

    function updateSettings( param, value ) {
      console.log(timestamp() + ' updateSettings()')            
      // Show spinner
      $('.spinner').show()
      data = {
            csrf_token    : '{{ csrf_token() }}' 
          }
      $.ajax({
        type		    : 'POST',
        url			    : ('/update_settings/' + param +'/' + value),
        dataType	  : 'json',
        headers     : { 'ignore-login-next': 'true' },
        encode		  : true,
        data        : data
      }) // using the done promise callback
      .done(function(data) {
        // log data to the console so we can see
        console.log(data)
        switch (data.status) {
          case 200:
            switch (data.param) {
              case 'offPeakAddHolidayEntry':
                el = `<tr id="offPeakHoliday_` + data.value + `">
                        <td class="text-dark">` + desc + `:</td>
                        <td class="text-primary">` + 
                          ( recurring ? 
                            'Elk jaar op ' + hDaySplit[0] + ' ' + hDaySplit[1] :
                            'In ' + hDaySplit[2] + ' op ' + hDaySplit[0] + ' ' + hDaySplit[1]
                          ) +
                          `<button 
                            type="button" 
                            id="offPeakDelete_` + data.value + `"
                            style="float: right;"
                            class="btn btn-xs btn-low-key-danger waves-effect waves-light" 
                            > 
                            <i class="fas fa-trash-alt"></i> Verwijder 
                          </button>
                        </td>
                      </tr>`
                $(el).insertBefore('tr#offPeakNewHolidayDate')
                // Add delete buttons
                $('#offPeakDelete_' + data.value).on('click', function(e) {
                  var id = $(this).attr("id").replace("offPeakDelete_", "")
                  updateSettings( 'offPeakDeleteEntry', id )
                  // Remove from view
                  $('tr#offPeakHoliday_' + id).remove()
                })
                $.Notification.autoHideNotify('success', 'top left', 'Gewijzigd', 'Daluren zon/feestdag opgeslagen [' + data.value + '].');
                break
              case 'offPeakDeleteEntry':
                $.Notification.autoHideNotify('success', 'top left', 'Gewijzigd', 'Daluren zon/feestdag verwijderd [' + data.value + '].');
                break
              default:
                $.Notification.autoHideNotify('success', 'top left', 'Gewijzigd', 'Instelling aangepast.');
                break
            }
            break
          case 404:
          default:
            $.Notification.notify('warning','top left', 'Onbekend', 'Instelling onbekend. Niet gewijzigd.');
            break
        }

      })
      .fail(function(data) {
        $.Notification.notify('error','top left', 'Connectie fout', 'Instelling niet gewijzigd.');
      })
      .always(function() {
        // Remove spinner
        $('.spinner').hide()
      })
    }

    var diag_data = {{ diag_json | safe }}

    jQuery(document).ready(function() {
      console.log(timestamp() + " file load completed!")
      $('pre#diag_json').html( 
        JSON.stringify(diag_data, undefined, 2) 
      )
      $('pre#diag_json').show()
      $('input#allowPeakOnePeriod').bootstrapToggle()
      $('input#allowPeakOnePeriod').change(function() {
        updateSettings( 'allowPeakOnePeriod', $(this).prop('checked') )
      })
      $('input#offpeakEnabled').bootstrapToggle()
      $('input#offpeakEnabled').change(function() {
        updateSettings( 'offpeakEnabled', $(this).prop('checked') )
      })

      $('input#autoSessionEnabled').bootstrapToggle()
      $('input#autoSessionEnabled').change(function() {
        updateSettings( 'autoSessionEnabled', $(this).prop('checked') )
      })
      $('input#autoSessionCondenseSameOdometer').bootstrapToggle()
      $('input#autoSessionCondenseSameOdometer').change(function() {
        updateSettings( 'autoSessionCondenseSameOdometer', $(this).prop('checked') )
      })
      $('td[id^=offPeak] > div:nth-child(2)').each(function( index ) {
        var id = $(this).parent().attr("id")
        for (i = 0; i < 24; i++) {
          $(this).append( "<span style='color: #00b19d;'>" + (i %24) + "</span>" )
        }
      })
      $('#holidayDate').datepicker({
          todayHighlight: true,
          autoclose: true,
          startDate : undefined,
          endDate   : undefined,
          format: "d MM yyyy",    // 7 January 2020
          language: 'nl'
      })
      $('#offPeakNewDate').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        // Clean data fields
        $('#holidayDate').val('')
        $('#holidayDescription').val('')
        // Set recurring to false
        $('#offPeakNewRecurring').find('i').toggleClass('fa-calendar-day', true)
        $('#offPeakNewRecurring').find('i').toggleClass('fa-redo-alt', false)
        // Show input
        $('tr#offPeakNewHolidayDate').toggle(200)
        $('#offPeakNewCancel').show()
        $('#offPeakNewSave').show()
        $(this).hide()
      })
      $('#offPeakNewCancel').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        $('tr#offPeakNewHolidayDate').toggle(200)
        $('#offPeakNewDate').show()
        $('#offPeakNewSave').hide()
        $(this).hide()
      })
      $('#offPeakNewRecurring').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        $(this).find('i').toggleClass('fa-calendar-day')
        $(this).find('i').toggleClass('fa-redo-alt')
      })
      $('#offPeakNewSave').on('click', function(e) {
        e.preventDefault()
        console.log(this.id)
        hDayDate = $('#holidayDate').val()
        hDaySplit = hDayDate.split(' ')
        if (hDaySplit == undefined || hDaySplit.length < 3) {
          $.Notification.autoHideNotify('warning', 'top left', 'Waarschuwing', 'Geen of onjuist datumveld ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        hDayMonth = -1
        $.each(months, function(i, month) {
					if (month == hDaySplit[1]) {
            hDayMonth = i
					}
				})
        if (hDayMonth == -1) {
          $.Notification.autoHideNotify('warning', 'top left', 'Waarschuwing', 'Geen of onjuist datumveld ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        desc = $('#holidayDescription').val()
        if (desc.length == 0) {
          $.Notification.autoHideNotify('warning', 'top left', 'Waarschuwing', 'Geen omschrijving ingevoerd. Zon/feestdag niet opgeslagen...')
          return
        }
        recurring = $('button#offPeakNewRecurring').html().indexOf("fa-redo-alt") >= 0
        updateSettings( 'offPeakAddHolidayEntry', hDaySplit[0] + '|' + hDayMonth + '|' + hDaySplit[2] + '|' + recurring + '|' + encodeURI(desc) )
        $('tr#offPeakNewHolidayDate').toggle()
        $('#offPeakNewDate').show()
        $('#offPeakNewSave').hide()
        $('#offPeakNewCancel').hide()
      })
      // Add delete buttons
      $('button[id^=offPeakDelete]').on('click', function(e) {
        var id = $(this).attr("id").replace("offPeakDelete_", "")
        updateSettings( 'offPeakDeleteEntry', id )
        // Remove from view
        $('tr#offPeakHoliday_' + id).remove()
      })
      $('button[data-toggle=tooltip]').tooltip({ boundary: 'window' })

      // Edit/ Save buttons
      $('button[id^=editbutton_]').on('click', function(e) {
        // editbutton_charger_name_editsave
        // editbutton_charger_name_cancel
        var id = $(this).attr("id").replace("editbutton_", "").replace("_editsave", "").replace("_cancel", "")
        if ($(this).attr("id").endsWith("_cancel")) {
          // Cancel
          $('#' + id + '_input').attr('readonly', 'readonly')
          $('#' + id + '_input').val($('#' + id + '_input').attr('placeholder'))
          $('#editbutton_' + id + '_cancel').hide()
          $('#editbutton_' + id + '_editsave').attr('data-original-title', 'Wijzigen')
          $('#editbutton_' + id + '_editsave').tooltip('hide')
          $('#editbutton_' + id + '_editsave').html('<i class="fas fa-lock"></i>')
          $('#editbutton_' + id + '_editsave').toggleClass('btn-low-key-warning', true)
          $('#editbutton_' + id + '_editsave').toggleClass('btn-primary', false)
          
        } else {
          if ($(this).html().indexOf("fa-lock") >= 0) {
            // Unlock
            $('#' + id + '_input').removeAttr('readonly')
            $('#editbutton_' + id + '_cancel').show()
            $('#editbutton_' + id + '_editsave').attr('data-original-title', 'Opslaan')
            $('#editbutton_' + id + '_editsave').tooltip('hide')
            $('#editbutton_' + id + '_editsave').html('<i class="far fa-save"></i>')
            $('#editbutton_' + id + '_editsave').toggleClass('btn-low-key-warning', false)
            $('#editbutton_' + id + '_editsave').toggleClass('btn-primary', true)
          } else {
            // Save
            // TODO - save it
            $('#' + id + '_input').attr('placeholder', $('#' + id + '_input').val())
            $('#' + id + '_input').attr('readonly', 'readonly')
            $('#editbutton_' + id + '_cancel').hide()
            $('#editbutton_' + id + '_editsave').attr('data-original-title', 'Wijzigen')
            $('#editbutton_' + id + '_editsave').tooltip('hide')
            $('#editbutton_' + id + '_editsave').html('<i class="fas fa-lock"></i>')
            $('#editbutton_' + id + '_editsave').toggleClass('btn-low-key-warning', true)
            $('#editbutton_' + id + '_editsave').toggleClass('btn-primary', false)
          }
        }
      })

       // Remove spinner
      $('.spinner').hide()
    })

    </script>

{% endblock %}
{% block content %}

<div class="wrapper" id="{{ var1 }}">
  <div class="container-fluid">

    <!-- Page-Title -->
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
            </div>
        </div>
    </div>
    <!-- end page title end breadcrumb -->


    <div class="row">
      <div class="col-md-12">
          <div class="card-box">
              <h4 class="header-title m-t-0 m-b-30">Instellingen</h4>

              <ul class="nav nav-tabs tabs-bordered nav-justified">
                <li class="nav-item">
                  <a href="#v-charger" class="nav-link{% if active==1 %} active{% endif %}" data-toggle="tab" aria-expanded="false"><i class="fas fa-charging-station"></i> Laadpunt</a>
                </li>
                <li class="nav-item">
                  <a href="#v-kwhmeter" class="nav-link{% if active==2 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-tachometer-alt"></i> kWh meter</a>
                </li>
                <li class="nav-item">
                  <a href="#v-network" class="nav-link{% if active==3 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-network-wired"></i> Netwerk</a>
                </li>
                <li class="nav-item">
                  <a href="#v-database" class="nav-link{% if active==4 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-database"></i> Database</a>
                </li>
                <li class="nav-item">
                  <a href="#v-hardware" class="nav-link{% if active==5 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-microchip"></i> Hardware</a>
                </li>
                <li class="nav-item">
                  <a href="#v-diagnostics" class="nav-link{% if active==6 %} active{% endif %}" data-toggle="tab" aria-expanded="true"><i class="fas fa-stethoscope"></i> Diagnostics</a>
                </li>
              </ul>

              <div class="tab-content">

                  <div class="tab-pane active" id="v-charger">
                    <div class="col-lg-12">
                      <div class="card-box">
                        <h4 class="m-t-0 header-title"><i class="fas fa-charging-station"></i> Laadpunt</h4>
                        <table class="table table-striped table-sm">
                          <tbody>

<script src="{{ url_for('static', filename='js/oppleo-edit-str.js') }}" shadydom></script>
 

                            <tr>
                                <td class="text-dark">Naam laadpunt:</td>
                                <td class="text-primary" style="width: 75%;">
                                    <oppleo-edit-str 
                                        prefix="&euro; " 
                                        value="0.34" 
                                        callback="submitItToServer">
                                    </oppleo-edit-str>
                                </td>
                            </tr>
    <script>
        // How to use this web component:
    function submitItToServer(value) {
        alert('submitItToServer')
    }
    
    </script>
                            <tr>
                                <td class="text-dark">Naam laadpunt:</td>
                                <td class="text-primary" style="width: 75%;">
                                  <div class="input-group">
                                    <input 
                                      class="form-control input-sm" 
                                      type="text"
                                      readonly="readonly"
                                      id="charger_name_input" 
                                      style="text-align: left;"
                                      placeholder="placeholder"
                                      value="value"
                                    />
                                    <span class="input-group-btn">
                                      <button
                                        id="editbutton_charger_name_cancel"
                                        type="button" 
                                        class="btn btn-xs waves-effect waves-light btn-secondary"
                                        style="display: none;"
                                        data-toggle="tooltip" 
                                        data-placement="bottom" 
                                        data-html="true" 
                                        title="<em>Annuleren</em>"
                                        >
                                        <i class="fas fa-times"></i>
                                      </button> 
                                      <button
                                        id="editbutton_charger_name_editsave"
                                        type="button" 
                                        class="btn btn-xs waves-effect waves-light btn-low-key-warning"
                                        data-toggle="tooltip" 
                                        data-placement="bottom" 
                                        data-html="true" 
                                        title="<em>Wijzigen</em>"
                                        >
                                        <i class="fas fa-lock"></i>
                                      </button> 
                                    </span>
                                  </div>
                                </td>
                              </tr>
   

                            <tr>
                                <td class="text-dark">Naam laadpunt:</td>
                                <td class="text-primary" style="width: 75%;">
                                </td>
                            </tr>



                          </tbody>


                        </table>
                      </div>
                    </div>
                  </div>


          </div>
      </div> <!-- end col -->
    </div> <!-- end row -->

  </div>
</div>
{% endblock %}
