{% extends "template.html" %}
{% block title %}Verbruik{% endblock %}
{% block head %}
  {{ super() }}
   
  <!-- Required Flot -->
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.time.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.tooltip.min.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.resize.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.pie.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.selection.j') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.stack.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.crosshair.js') }}"></script>
  <script src="{{ url_for('static', filename='plugins/flot-chart/jquery.flot.navigate.js') }}"></script>

  <!-- Socket IO -->
  <script src="{{ url_for('static', filename='plugins/socket.io/2.3.0/socket.io.js') }}"></script>

  <style>
    .paginate_button {
        padding: 0px !important;
    }
    tbody td {
      padding: 2px 2px !important;
      text-align: center;
      background-color: #36404a;
    }
    div .dataTables_info {
      color: #98a6ad !important;
      margin-left: 5px;
    }
    div .dt-buttons {
      margin-bottom: 10px;
      margin-left: 3px;
    }
    div .dataTables_length {
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 100%;
    }
    div .dataTables_length label {
      font-size: smaller;
      margin-left: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 100%;
      color: #98a6ad !important;
    }
    div .dataTables_length label select {
      width: 80px;
      margin-left: 10px;
      margin-right: 10px;
    }
  </style>

  <script>
    function timestamp() {
      d = new Date();
      return (d.getFullYear() + "-" + 
             (d.getMonth()<10?'0':'') + (d.getMonth()+1) + "-" + 
             (d.getDate()<10?'0':'') + d.getDate() + '.' + 
             (d.getHours()<10?'0':'') + d.getHours() + ":" + 
             (d.getMinutes()<10?'0':'') + d.getMinutes() + "." + 
             (d.getSeconds()<10?'0':'') + d.getSeconds() + '.' + 
             (d.getMilliseconds()<100?'0':'') + (d.getMilliseconds()<10?'0':'') + d.getMilliseconds()
      )
    }
    var dt = undefined
    function getUsageData( from_timestamp, n = undefined ) {
      console.log(timestamp() + ' getUsageData()')
    
//      $.Notification.autoHideNotify('warning', 'top left', 'Loggin out', 'Logging out from Splash!');
            
      $.ajax({
        type		: 'GET',
        url			: ('/usage_data_since/' + encodeURI(from_timestamp) + (Number.isInteger(n) ? '/' + n : '')),
        dataType	: 'json',
            encode		: true
      }) // using the done promise callback
      .done(function(data) {
        // log data to the console so we can see
        console.log(data)
  //        $.Notification.autoHideNotify('success', 'top left', 'Logged out', 'Logged out of Splash. Redirecting to login page.');

        var flotDataset = []
        var flotDataL1A = []
        var flotDataL2A = []
        var flotDataL3A = []
        var flotDataL1P = []
        var flotDataL2P = []
        var flotDataL3P = []
        var flotDatakWhTotal = []

        var flotGraph = $.plot($("#stecapg_1_flotgraph"), flotDataset, {
          tooltip : true, //activate tooltip
          tooltipOpts : {
            content: function(label, xval, yval, flotItem) {
              var d = new Date(parseInt(xval));
              var monthNames = [
                "January", "February", "March",
                "April", "May", "June", "July",
                "August", "September", "October",
                "November", "December"
              ]
              var ttStr = '<span style="color: ' + flotItem.series.color + ' !important"><i class="fas fa-charging-station"></i> ' + 
                  flotItem.series.label + ' ' + yval + 
                  (flotItem.series.label.endsWith('A') ? 'A' : 
                    (flotItem.series.label.endsWith('P') ? 'W' :
                      (flotItem.series.label.endsWith('kWh') ? 'kWh' : '')
                    )
                  ) +
                  '</span><br>' + 
                  '<span style="color: #98a6ad !important"><i class="fa fa-calendar"></i> ' + 
                  d.getDate() + " " + 
                  monthNames[d.getMonth()] + 
                  " " + d.getFullYear() + 
                  " " + (d.getHours() < 10 ? "0" : "" ) + d.getHours() +
                  ":" + (d.getMinutes() < 10 ? "0" : "" ) + d.getMinutes() +
                  '</span>'

              return ttStr
            },
            shifts : {
              x : 5,
              y : -30    // 140
            }
          },
          grid : {
            show : true,
            aboveData : false,
            color : '#36404a',
            borderColor : '#36404a',
            labelMargin : 15,
            axisMargin : 0,
            borderWidth : 0,
            borderColor : null,
            minBorderMargin : 5,
            clickable : true,
            hoverable : true,
            autoHighlight : false,
            mouseActiveRadius : 20
          },
          zoom: {
            interactive: true
/*            active: true,
            amount: 1.5,         // 2 = 200% (zoom in), 0.5 = 50% (zoom out)
            enableTouch: true
          */          },
          pan: {
            interactive: true
/*            active: true,
            cursor: "move",     // CSS mouse cursor value used when dragging, e.g. "pointer"
            frameRate: 60,
            mode: "smart",       // enable smart pan mode
            enableTouch: true,
            touchMode: ""
          */         },
          yaxis: [{   // Amps 0-25
            min: 0, 
            max: 25,
            font : {
              color : '#00b19d'
            },
            axisLabel: 'Amps',
            zoomRange: [0.1, 10],
    				panRange: [-10, 10],
            axisZoom: true, //zoom axis when mouse over it is allowed
            plotZoom: true, //zoom axis is allowed for plot zoom
            axisPan: true, //pan axis when mouse over it is allowed
            plotPan: true //pan axis is allowed for plot pan
          }, {        // Volts 0-250
            min: 0, 
            max: 250,
            font : {
              color : '#3bafda'
            },
            position: 'right',
            axisLabel: 'Volts',
            zoomRange: [0.1, 10],
    				panRange: [-10, 10],
            axisZoom: true, //zoom axis when mouse over it is allowed
            plotZoom: true, //zoom axis is allowed for plot zoom
            axisPan: true, //pan axis when mouse over it is allowed
            plotPan: true //pan axis is allowed for plot pan
          }, {        // kWh ever increasing
            min: 0, 
            max: 400,
            font : {
              color : '#ffaa00'
            },
            position: 'right',
            axisLabel: 'kWh',
            zoomRange: [0.1, 10],
    				panRange: [-10, 10],
            axisZoom: true, //zoom axis when mouse over it is allowed
            plotZoom: true, //zoom axis is allowed for plot zoom
            axisPan: true, //pan axis when mouse over it is allowed
            plotPan: true //pan axis is allowed for plot pan
          }],

//					tickFormatter: euroFormatter

          xaxis: { 
            show : true,
            font : {
              color : '#98a6ad'
            },
//                tickDecimals: 0,
            timezone: 'browser',
//            minTickSize: [1, "minute"],
            timeformat: "%a %d %b %H:%M",
//                twelveHourClock: false,
            mode: "time",
            min: (new Date(new Date().getFullYear(), new Date().getMonth(), (new Date().getDate()-7), 0, 0)).getTime(),
            max: (new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate(), 6, 0)).getTime(),
            zoomRange: [0.1, 10],
    				panRange: [-10, 10],
            axisZoom: true, //zoom axis when mouse over it is allowed
            plotZoom: true, //zoom axis is allowed for plot zoom
            axisPan: true, //pan axis when mouse over it is allowed
            plotPan: true //pan axis is allowed for plot pan
          },
          axisLabels: {
            show: true
          } 
        })


        data.forEach(element => {
          console.log(element.created_at)
            // created_at format 01/04/2020, 13:58:44
          var ts = new Date(element.created_at).getTime()

          flotDataL1A.push( [ ts, element.a_l1 ] )
          flotDataL2A.push( [ ts, element.a_l2 ] )
          flotDataL3A.push( [ ts, element.a_l3 ] )

          flotDataL1P.push( [ ts, element.p_l1 ] )
          flotDataL2P.push( [ ts, element.p_l2 ] )
          flotDataL3P.push( [ ts, element.p_l3 ] )

          flotDatakWhTotal.push( [ ts, element.kw_total ] )

/*        
          $("span#energy_device_id").text("("+element.energy_device_id+")")
          dt.row.add([
            element.created_at,
            element.kw_total +'kWh',
            element.kwh_l1 +'kWh',
            element.kwh_l2 +'kWh',
            element.kwh_l3 +'kWh',
            element.a_l1 +'A',
            element.a_l2 +'A',
            element.a_l3 +'A',
            element.p_l1 +'W',
            element.p_l2 +'W',
            element.p_l3 +'W',
            element.v_l1 +'V',
            element.v_l1 +'V',
            element.v_l3 +'V',
            element.hz +' Hz'
          ]).draw( false )
*/
        })
        // blue     #505a66 
        flotDataset.push( { label: 'L1 A', data: flotDataL1A, color: "#00b19d", yaxis: 1 })
        flotDataset.push( { label: 'L2 A', data: flotDataL2A, color: "#00b19d", yaxis: 1 })
        flotDataset.push( { label: 'L3 A', data: flotDataL3A, color: "#00b19d", yaxis: 1 })

        flotDataset.push( { label: 'L3 P', data: flotDataL1P, color: "#3bafda", yaxis: 2 })
        flotDataset.push( { label: 'L3 P', data: flotDataL2P, color: "#3bafda", yaxis: 2 })
        flotDataset.push( { label: 'L3 P', data: flotDataL3P, color: "#3bafda", yaxis: 2 })

        flotDataset.push( { label: 'kWh', data: flotDatakWhTotal, color: "#ffaa00", yaxis: 3 })

        flotGraph.setData( flotDataset );
        flotGraph.setupGrid();
        flotGraph.draw();

        $('#stecapg_1_waiting').toggleClass( 'invisible', true );
      })
      .fail(function() {
  //      $.Notification.notify('error','top left', 'Connection error', 'Could not process logout! Please close your browser to complete logout.');
      })
      .always(function() {
        // Check every 60 seconds
      })
    }
    var socket = undefined
    function startWebSocket() {
      console.log(timestamp() + ' startWebSocket()')
      // start up the SocketIO connection to the server - the namespace 'test' is also included here if necessary
      socket = io.connect('http://'+window.location.hostname+':'+window.location.port+'/usage')
      // this is a callback that triggers when the "my response" event is emitted by the server.
      socket.on('status_update', function(msg) {
        console.log('Received: ' + JSON.stringify(msg.data))

        // Check if entry does not already exist. After a server restart the last entry is always re-sent. 
        var entryExists = false
        dt.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
          var data = this.data()
          if (data[0] === msg.data.created_at) {
            console.log('Websocket data entry ['+msg.data.created_at+'] already in table through initial pull request.')
            entryExists = true
            // currently no way to stop the every() loop... (return false does not work)
            return false
          }
        })
        if (entryExists) {
          return
        }

        dt.row.add([
            msg.data.created_at,
            msg.data.kw_total +'kWh',
            msg.data.kwh_l1 +'kWh',
            msg.data.kwh_l2 +'kWh',
            msg.data.kwh_l3 +'kWh',
            msg.data.a_l1 +'A',
            msg.data.a_l2 +'A',
            msg.data.a_l3 +'A',
            msg.data.p_l1 +'W',
            msg.data.p_l2 +'W',
            msg.data.p_l3 +'W',
            msg.data.v_l1 +'V',
            msg.data.v_l1 +'V',
            msg.data.v_l3 +'V',
            msg.data.hz +'Hz'
          ]).draw( false )
      })
      $("#tr_41").toggleClass("testbg").fadeOut(400, function() {
        $(this).toggleClass("testbg").fadeIn(0)
})
    }
    //example of triggering an event on click of a form submit button
    function sendSocketMsg() {
        socket.emit('my event', {data: $('#emit_data').val()});
    }

    function formatDate(date) {
      return (date.getDate() < 10 ? '0' : '') + date.getDate() + '/' +
             (date.getMonth() < 10 ? '0' : '') + date.getMonth() + '/' +
             date.getFullYear() + ', ' + 
             (date.getHours() < 10 ? '0' : '') + date.getHours() + ':' +
             (date.getMinutes() < 10 ? '0' : '') + date.getMinutes() + ':' +
             (date.getSeconds() < 10 ? '0' : '') + date.getSeconds()
    }

    jQuery(document).ready(function () {
      console.log(timestamp() + " file load completed!")
      startWebSocket()
      var from_timestamp = new Date()
      from_timestamp.setDate(from_timestamp.getDate()-7)
{% if (cnt != None) and (cnt != 'undefined') %}
      getUsageData(
        formatDate, 
        {{ cnt }}
      )
{% else %}
      getUsageData(
        formatDate(from_timestamp)
      )
{% endif %}
    })


    </script>

{% endblock %}
{% block content %}

<div class="wrapper" id="{{ var1 }}">
  <div class="container-fluid">

    <!-- Page-Title -->
    <div class="row">
        <div class="col-sm-12">
            <div class="page-title-box">
                <div class="btn-group pull-right">
                    <ol class="breadcrumb hide-phone p-0 m-0">
                        <li class="breadcrumb-item"><a href="#">Verbruik</a></li>
                        <li class="breadcrumb-item active">Verbruik</li>
                    </ol>
                </div>
                <h4 class="page-title">Verbruik</h4>
            </div>
        </div>
    </div>
    <!-- end page title end breadcrumb -->


    <div class="row">


      <div id="stecapg_1" class="col-lg-12">
        <div class="portlet"><!-- /primary heading -->
            <div class="portlet-heading">
                <h3 class="portlet-title text-dark">Verbruik</h3>
                <div class="clearfix"></div>
                <div class="btn-group" style="position: absolute; top: 55px; left: 67px;">
                    <button type="button" id="stecapg_1_yaxeszoomout" class="btn btn-outline-secondary btn-sm waves-effect waves-light" style="width: 38px;" onclick="flotGraphs[ 'stecapg_1' ].getOptions().yaxes[0].max = flotGraphs[ 'stecapg_1' ].getOptions().yaxes[0].max / 2; flotGraphs[ 'stecapg_1' ].setupGrid(); flotGraphs[ 'stecapg_1' ].draw();"> <i class="fa fa-search-plus"></i> </button>
                    <button type="button" id="stecapg_1_yaxeszoomin" class="btn btn-outline-secondary btn-sm waves-effect waves-light" style="width: 38px;" onclick="flotGraphs[ 'stecapg_1' ].getOptions().yaxes[0].max = flotGraphs[ 'stecapg_1' ].getOptions().yaxes[0].max * 2; flotGraphs[ 'stecapg_1' ].setupGrid(); flotGraphs[ 'stecapg_1' ].draw();"> <i class="fa fa-search-minus"></i> </button>
               </div>
                <div class="btn-group" style="position: absolute; top: 55px; left: 150px;">
                    <button type="button" id="stecapg_1_toggleLegenda" class="btn btn-outline-secondary btn-sm waves-effect waves-light" style="width: 38px;" onclick="flotGraphs[ 'stecapg_1' ].getOptions().legend.show = (! ( flotGraphs[ 'stecapg_1' ].getOptions().legend.show ) ); flotGraphs[ 'stecapg_1' ].setupGrid(); flotGraphs[ 'stecapg_1' ].draw();"> <i class="ion-map"></i> </button>
               </div>
            </div>
            <div id="portlet 1" class="panel-collapse collapse show">
                <div class="portlet-body">
                    <div id="stecapg_1_flotgraph" style="height: 320px;" class="flot-chart"></div>
                    <div id="stecapg_1_waiting" style="position: absolute; top: 50%; left: 50%; font-size: 30px;" class="flot-chart"> <i class="fas fa-spinner fa-spin fa-1x"></i> </div>
                </div>
            </div>
        </div>
    </div>




    </div> <!-- end row -->

  </div>
</div>
{% endblock %}
